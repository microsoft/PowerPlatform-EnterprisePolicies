# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

PowerShell module and scripts for managing Power Platform Enterprise Policies as Azure resources. Supports:
- **Customer Managed Key (CMK)** policies for encryption
- **Subnet Injection** policies for virtual network delegation
- Diagnostic tools for VNET functionality troubleshooting

Supports multiple Azure environments: AzureCloud, AzureUSGovernment (DoD, USGovHigh), AzureChinaCloud.

## Build Commands

```powershell
# Restore NuGet packages (required before building/testing)
dotnet restore

# Build the module to Release directory
Build/build.ps1 -Tasks @("Build")

# Run tests (in current PowerShell environment)
Build/build.ps1 -Tasks @("Test")

# Build and test together
Build/build.ps1 -Tasks @("Build", "Test")

# Generate markdown documentation (updates docs/ folder)
Build/build.ps1 -Tasks @("BuildHelp")
```

**Testing requirement:** Tests must pass on both PowerShell (Core) and Windows PowerShell. The test command only runs in the current environment, so you must invoke it separately in each:
```powershell
# Run in Windows PowerShell
powershell -Command "Build/build.ps1 -Tasks @('Test')"

# Run in PowerShell Core
pwsh -Command "Build/build.ps1 -Tasks @('Test')"
```

**Important:** The `docs/` folder contains autogenerated documentation. After any changes to module scripts, run `.\Build\build.ps1 -Tasks @("BuildHelp")` to regenerate the docs.

**Exception:** Types in `Private/Types.psm1` (classes and enums) cannot be autogenerated and require manual documentation updates in `docs/`.

**Note:** Non-Microsoft contributors must modify `Nuget.config` to point to the public NuGet repository.

## Running Tests

Tests use Pester loaded from NuGet packages (version defined in `Directory.Packages.props`). The test framework validates:
- Module structure and manifest
- Public/Private functions
- File headers (Microsoft sample code disclaimer required)

```powershell
# Load test environment in VSCode (Run and Debug > "Load Modules")
# Or manually:
. Source/Tests/Shared.ps1

# Tests are in Source/Tests/*.Tests.ps1
# Mock Azure module: Source/Tests/FakeAzModule/FakeAZ.psd1
```

## Architecture

### Module Structure
```
Source/Microsoft.PowerPlatform.EnterprisePolicies/
├── Public/
│   └── SubnetInjection/
│       ├── New-VnetForSubnetDelegation.ps1  # VNet setup cmdlet
│       └── Diagnostics/                      # Diagnostic cmdlets
│           ├── Get-EnvironmentUsage.ps1
│           ├── Get-EnvironmentHistoricalUsage.ps1
│           ├── Get-EnvironmentRegion.ps1
│           ├── Test-AccountPermissions.ps1
│           ├── Test-DnsResolution.ps1
│           └── Test-NetworkConnectivity.ps1
└── Private/                   # Internal implementation
    ├── Types.psm1             # Enums: BAPEndpoint, AzureEnvironment, PolicyType
    ├── AuthenticationOperations.ps1  # Connect-Azure, Get-AccessToken
    ├── RESTHelpers.ps1        # HTTP client with retry logic, BAP API endpoints
    ├── AzHelper.ps1           # Azure resource operations
    ├── CacheMethods.ps1       # Response caching
    └── VnetValidations.ps1    # Network validation
```

### Legacy Scripts (DO NOT follow these patterns)
Everything under `Source/` outside the module and tests is legacy code being replaced:
- `Source/Cmk/` - Legacy CMK scripts
- `Source/SubnetInjection/` - Legacy subnet injection scripts
- `Source/Common/` - Legacy shared helpers
- `Source/Identity/` - Legacy identity scripts

**Do not use these as reference for new code.** Follow patterns in the module only.

`Source/Tests/` is NOT legacy - it contains the Pester tests for the module.

### Key Types (Private/Types.psm1)
- `BAPEndpoint` enum: tip1, tip2, prod, usgovhigh, dod, china
- `AzureEnvironment` enum: AzureCloud, AzureChinaCloud, AzureUSGovernment
- `PolicyType` enum: Encryption, NetworkInjection, Identity
- Data classes: `NetworkUsage`, `VnetInformation`, `EnvironmentNetworkUsageDocument`

### REST API Pattern
The module uses `RESTHelpers.ps1` for all BAP (Business Application Platform) API calls:
- Singleton `HttpClient` with User-Agent header
- Retry logic with `Retry-After` header support (429/503 responses)
- Environment-specific endpoints via `Get-APIResourceUrl`

### Authentication Flow
`AuthenticationOperations.ps1` handles Azure authentication:
- Reuses existing `AzContext` when available
- Maps `BAPEndpoint` to `AzureEnvironment` for login
- Supports tenant-specific authentication with `-TenantId`

## Code Conventions

### Required File Header
All `.ps1` files must start with this Microsoft sample code disclaimer:
```powershell
<#
SAMPLE CODE NOTICE

THIS SAMPLE CODE IS MADE AVAILABLE AS IS. MICROSOFT MAKES NO WARRANTIES, WHETHER EXPRESS OR IMPLIED,
OF FITNESS FOR A PARTICULAR PURPOSE, OF ACCURACY OR COMPLETENESS OF RESPONSES, OF RESULTS, OR CONDITIONS OF MERCHANTABILITY.
THE ENTIRE RISK OF THE USE OR THE RESULTS FROM THE USE OF THIS SAMPLE CODE REMAINS WITH THE USER.
NO TECHNICAL SUPPORT IS PROVIDED. YOU MAY NOT DISTRIBUTE THIS CODE UNLESS YOU HAVE A LICENSE AGREEMENT WITH MICROSOFT THAT ALLOWS YOU TO DO SO.
#>
```

### Common Parameters for Public Cmdlets
Public cmdlets that call Azure/BAP APIs should include these common parameters:
- `TenantId` - Optional Azure AD tenant ID
- `Endpoint` - BAP endpoint (default: `[BAPEndpoint]::Prod`)
- `ForceAuth` - Switch to force re-authentication instead of reusing existing session

### General Conventions
- Public functions go in `Public/` subdirectories, private in `Private/`
- Each public/private function should have a corresponding test file
- Functions use advanced parameter validation with `CmdletBinding`
- Use `$ErrorActionPreference = "Stop"` at the start of functions

## Dependencies

Required PowerShell modules (installed via `InstallPowerAppsCmdlets.ps1`):
- Az.Accounts, Az.Network, Az.Resources, Az.PowerPlatform
- Pester (via NuGet for testing, version in `Directory.Packages.props`)

## Git Workflow

- **Never push directly to main** - the repository requires pull requests
- **Always create a feature branch** with the naming pattern: `user-alias/relevant-branch-name`
  - Example: `osfaixat/update-environmentregion-api`
- Create a pull request from your feature branch to main

## CI/CD

Azure Pipelines with security scanning (CodeQL, CredScan, BinSkim, PoliCheck). Version managed by GitVersion with semantic versioning.

## PR Checklist

Before submitting a PR, ensure:
1. **If module code changed** (`Source/Microsoft.PowerPlatform.EnterprisePolicies/`):
   - Tests pass in both PowerShell Core (`pwsh`) and Windows PowerShell (`powershell`)
   - Run `Build/build.ps1 -Tasks @("BuildHelp")` to regenerate docs
2. Update `README.md` if adding new user-facing features or parameters
3. If modifying `Types.psm1`, manually update the corresponding docs in `docs/`

**Note:** Tests are not required for changes to legacy scripts, README.md, CLAUDE.md, or other non-module files.
